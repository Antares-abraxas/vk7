# Отчёт по безопасному развёртыванию Docker-контейнеров

### 1. Защита секретных данных

**Обнаруженные секреты:**
1. Пароль пользователя `appadmin`: `Sup3rS3cr3tP@ssw0rd123`
2. Секретный токен приложения: `11d979b1092a5495233be01d8b5227eb`
   
**Проблема**:  
Жёстко заданные секреты (пароль пользователя и токен приложения) в открытом виде в playbook.

**Риски:**
- При коммите в Git секреты остаются в истории навсегда
- Доступны всем разработчикам с доступом к репозиторию
- Могут быть обнаружены сканерами безопасности (например, truffleHog)

**Решение**:  
Секреты вынесены в отдельный файл `secrets.yml`, зашифрованный с помощью Ansible Vault. В playbook добавлена задача загрузки секретов:

```yaml
- name: Load secrets from vault
  include_vars:
    file: secrets.yml
    name: secrets
  tags: always
```

### 2. Настройка брандмауэра 

**Проблема:**
Полное отключение брандмауэра делало систему уязвимой для сетевых атак.

**Риски:**
- Открыты все порты (0.0.0.0/0)
- Возможность:
  - Bruteforce-атак на SSH
  - Доступа к административным интерфейсам
  - Распространения malware внутри сети
- Игнорирование ошибок (ignore_errors: yes) скрывает:
  - Проблемы с зависимостями
  - Ошибки конфигурации
  - Проблемы прав доступа
    
**Решение:**
Настройка избирательного доступа только к необходимым портам:

```yaml
- name: Configure firewall rules
  ufw:  # Явно разрешаем только нужные порты
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - 8080  # Для secure-app
    - 5000  # Для vuln-app
  notify: enable firewall
  tags: security
```

### 3. Проверка целостности файлов

**Проблема:**
Отсутствие проверки скачиваемых файлов.

**Риск:**
Атака "Man-in-the-Middle" может подменить архив на:
  - Вредоносный код (backdoor)
  - Устаревшую версию с уязвимостями
  - Поврежденный архив

**Решение:**
Добавлена проверка контрольной суммы SHA256:

```yaml
    download_url: "https://github.com/octocat/Hello-World/tarball/master"
    download_checksum: "9f40b519431e9754a1680244b820877ca975aa969ea4ae72798bfe3f67d0f139"  # Получаем так: curl -L URL | sha256sum
```

```yaml
- name: Download application archive (с проверкой целостности)
  get_url:
    url: "{{ download_url }}"
    dest: "/tmp/app.tar.gz"
    checksum: "{{ download_checksum }}"  # Обязательная проверка
    timeout: 30
  tags: app
```

###4. Безопасность образов 

**Проблема:**
Использование устаревшего образа nginx.

**Уязвимости в nginx:1.18.0:**
- CVE-2021-23017 (CVSS 9.8) - переполнение буфера
- CVE-2022-41741 - уязвимость в модуле gzip
- Отсутствие исправлений для 0-day уязвимостей

**Решение:**
Обновление до актуальной версии:

```yaml
nginx_image: "nginx:1.25.3"
```

### 5. Права доступа

**Проблема:**
Небезопасные разрешения 0777.

**Риски:**
Любой пользователь может:
- Изменить файлы приложения (rwx)
- Удалить логи
- Подменить конфигурации

**Решение:**
Установка минимально необходимых прав:

```yaml
- name: Set permissions on work directory
  file:
    path: "{{ work_dir }}"
    state: directory
    recurse: yes
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: '0750'
  tags: permissions
```

### 6. Защита токена 

**Найденный токен:**
11d979b1092a5495233be01d8b5227eb 

**Проблема:**
Токен в открытом виде в HTML. 

**Решение:**
Передача через переменные окружения:

```yaml
env:
    SECRET_TOKEN: "{{ secrets.secret_token }}"
```
